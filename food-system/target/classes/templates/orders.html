<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORDER FLOW MATRIX | Food System Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <link th:href="@{/css/cyber-admin.css}" rel="stylesheet">
</head>
<body class="cyber-theme">
    <canvas id="cyberBackground" class="cyber-bg"></canvas>
    <nav class="cyber-nav">
        ...existing code...
    </nav>
    <div class="command-center">
        <!-- Orders grouped by user -->
        <div class="cyber-card">
            <h2><i class="fas fa-users"></i> Orders by User</h2>
            <div th:each="entry : ${ordersByUser}">
                <div class="user-orders-section mb-4">
                    <h4 th:text="${entry.key.name} + ' (' + ${entry.key.email} + ')'">User Name (Email)</h4>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="order : ${entry.value}" th:data-order-id="${order.id}" th:onclick="|showOrderDetails(${order.id})|" style="cursor:pointer;">
                                <td th:text="${order.id}"></td>
                                <td th:text="${#dates.format(order.date, 'yyyy-MM-dd HH:mm')}"></td>
                                <td th:text="${order.status}"></td>
                                <td th:text="${order.total}"></td>
                                <td>
                                    <button class="btn btn-info btn-sm" th:onclick="|showOrderDetails(${order.id});event.stopPropagation();|">View</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- ...existing analytics, metrics, and driver optimization cards... -->

        <!-- PREDICTIVE ANALYTICS -->
        <div class="cyber-card predictive-analytics">
            <div class="card-header">
                <h3><i class="fas fa-crystal-ball"></i> PREDICTIVE ORDER FLOW</h3>
                <div class="prediction-accuracy">
                    <span>89% ACCURACY</span>
                </div>
            </div>
            <div class="predictive-content">
                <div class="prediction-chart">
                    <canvas id="orderPredictionChart" width="400" height="200"></canvas>
                </div>
                <div class="prediction-insights">
                    <div class="insight-item">
                        <div class="insight-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="insight-content">
                            <h5>PEAK HOUR INCOMING</h5>
                            <p>Expected 142 orders in next 2 hours</p>
                            <span class="insight-confidence">87% confidence</span>
                        </div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="insight-content">
                            <h5>BOTTLENECK ALERT</h5>
                            <p>Kitchen capacity may be reached by 7:30 PM</p>
                            <span class="insight-confidence">92% confidence</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ORDER PERFORMANCE METRICS -->
        <div class="cyber-card performance-metrics">
            <div class="card-header">
                <h3><i class="fas fa-tachometer-alt"></i> PERFORMANCE ANALYTICS</h3>
                <div class="time-selector">
                    <select class="cyber-select" id="performanceTimeframe">
                        <option value="today">TODAY</option>
                        <option value="week">THIS WEEK</option>
                        <option value="month">THIS MONTH</option>
                    </select>
                </div>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">24.3<span>m</span></div>
                    <div class="metric-label">Average Completion Time</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-down"></i> 12% faster
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">98.7<span>%</span></div>
                    <div class="metric-label">On-Time Delivery</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i> 3.2% better
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">4.2<span>/5</span></div>
                    <div class="metric-label">Customer Rating</div>
                    <div class="metric-trend neutral">
                        <i class="fas fa-minus"></i> No change
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">$42.50</div>
                    <div class="metric-label">Average Order Value</div>
                    <div class="metric-trend positive">
                        <i class="fas fa-arrow-up"></i> 8.5% higher
                    </div>
                </div>
            </div>
        </div>

        <!-- DRIVER OPTIMIZATION -->
        <div class="cyber-card driver-optimization">
            <div class="card-header">
                <h3><i class="fas fa-shipping-fast"></i> DELIVERY OPTIMIZATION</h3>
                <div class="optimization-status">
                    <span class="status-dot optimized"></span>
                    <span>SYSTEM OPTIMIZED</span>
                </div>
            </div>
            <div class="optimization-content">
                <div class="driver-map">
                    <div class="map-container" id="deliveryMap">
                        <!-- Delivery map visualization -->
                        <div class="driver-node" style="top: 30%; left: 25%;" data-driver="D-001">
                            <div class="node-pulse"></div>
                            <div class="node-info">
                                <strong>D-001</strong><br>
                                2 deliveries<br>
                                15 min ETA
                            </div>
                        </div>
                        <div class="driver-node" style="top: 60%; left: 70%;" data-driver="D-002">
                            <div class="node-pulse"></div>
                            <div class="node-info">
                                <strong>D-002</strong><br>
                                1 delivery<br>
                                8 min ETA
                            </div>
                        </div>
                    </div>
                </div>
                <div class="driver-stats">
                    <div class="driver-list">
                        <h5>ACTIVE DRIVERS</h5>
                        <div class="driver-item">
                            <div class="driver-avatar">D-001</div>
                            <div class="driver-info">
                                <span class="driver-name">Mike Rodriguez</span>
                                <span class="driver-status delivering">DELIVERING</span>
                            </div>
                            <div class="driver-metrics">
                                <span class="metric">2/5 orders</span>
                                <span class="rating">4.8★</span>
                            </div>
                        </div>
                        <div class="driver-item">
                            <div class="driver-avatar">D-002</div>
                            <div class="driver-info">
                                <span class="driver-name">Sarah Chen</span>
                                <span class="driver-status available">AVAILABLE</span>
                            </div>
                            <div class="driver-metrics">
                                <span class="metric">1/5 orders</span>
                                <span class="rating">4.9★</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDER DETAILS MODAL -->
    <div class="modal cyber-modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"><i class="fas fa-file-invoice"></i> ORDER DETAILS</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="order-details-content" id="orderDetailsContent">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/cyber-dashboard.js}"></script>
    <script th:src="@{/js/real-time-updates.js}"></script>
    <script th:src="@{/js/order-flow.js}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initOrderFlow();
            startOrderStream();
            loadOrderPredictions();
        });

        function showOrderDetails(orderId) {
            fetch(`/admin/orders/${orderId}/details`)
                .then(response => response.json())
                .then(data => {
                    let html = `<div><strong>Order ID:</strong> ${data.id}</div>`;
                    html += `<div><strong>Date:</strong> ${data.date}</div>`;
                    html += `<div><strong>Status:</strong> ${data.status}</div>`;
                    html += `<div><strong>Total:</strong> $${data.total}</div>`;
                    if (data.user) {
                        html += `<div><strong>User:</strong> ${data.user.name} (${data.user.email})</div>`;
                    }
                    if (data.items && data.items.length > 0) {
                        html += `<div><strong>Items:</strong><ul>`;
                        data.items.forEach(item => {
                            html += `<li>${item.name} x${item.quantity} - $${item.price}</li>`;
                        });
                        html += `</ul></div>`;
                    }
                    document.getElementById('orderDetailsContent').innerHTML = html;
                    var modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                    modal.show();
                })
                .catch(() => {
                    document.getElementById('orderDetailsContent').innerHTML = '<div class="text-danger">Failed to load order details.</div>';
                    var modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                    modal.show();
                });
        }
    </script>
</body>
</html>